#!/bin/sh

# SBaGen macOS build script with optional parameters
# Usage: ./mk-macos [-x86] [-universal] [-mp3] [-ogg]
#   -x86: Build for Intel x86_64 architecture (default is ARM64/Apple Silicon)
#   -universal: Build a universal binary (both ARM64 and x86_64)
#   -mp3: Include MP3 support
#   -ogg: Include OGG support

# Default settings
ARCH="arm64"
UNIVERSAL=0
USE_MP3=0
USE_OGG=0

# Parse command line arguments
for arg in "$@"; do
    case "$arg" in
        -x86)
            ARCH="x86_64"
            ;;
        -universal)
            UNIVERSAL=1
            ;;
        -mp3)
            USE_MP3=1
            ;;
        -ogg)
            USE_OGG=1
            ;;
        *)
            echo "Unknown option: $arg"
            echo "Usage: ./mk-macos [-x86] [-universal] [-mp3] [-ogg]"
            exit 1
            ;;
    esac
done

# If building universal binary, build both architectures and combine them
if [ $UNIVERSAL -eq 1 ]; then
    echo "Building universal binary (ARM64 + x86_64)..."
    
    # Build ARM64 version
    echo "Building for Apple Silicon (ARM64)..."
    ARCH="arm64"
    CFLAGS="-DT_MACOSX -arch arm64 -mmacosx-version-min=11.0 -DNO_CARBON -Wno-deprecated-declarations"
    LIB_SUFFIX="arm64"
    LIBS="-framework CoreAudio"
    
    # Add MP3 support if requested
    if [ $USE_MP3 -eq 1 ]; then
        LIB_PATH="libs/macos-$LIB_SUFFIX-libmad.a"
        if [ -f "$LIB_PATH" ]; then
            CFLAGS="$CFLAGS -DMP3_DECODE"
            LIBS="$LIBS $LIB_PATH"
            ranlib "$LIB_PATH"
            echo "Including MP3 support using: $LIB_PATH"
        else
            echo "Warning: MP3 library not found at $LIB_PATH"
        fi
    fi
    
    # Add OGG support if requested
    if [ $USE_OGG -eq 1 ]; then
        LIB_PATH="libs/macos-$LIB_SUFFIX-libvorbisidec.a"
        if [ -f "$LIB_PATH" ]; then
            CFLAGS="$CFLAGS -DOGG_DECODE"
            LIBS="$LIBS $LIB_PATH"
            ranlib "$LIB_PATH"
            echo "Including OGG support using: $LIB_PATH"
        else
            echo "Warning: OGG library not found at $LIB_PATH"
        fi
    fi
    
    # Compile ARM64 version
    echo "Compilation flags (ARM64): $CFLAGS"
    echo "Libraries (ARM64): $LIBS"
    cc $CFLAGS -Wall -O3 sbagen+.c $LIBS -lm -lpthread -o sbagen+.arm64 || exit 1
    
    # Build x86_64 version
    echo "Building for Intel (x86_64)..."
    ARCH="x86_64"
    CFLAGS="-DT_MACOSX -arch x86_64 -mmacosx-version-min=10.9 -DNO_CARBON -Wno-deprecated-declarations"
    LIB_SUFFIX="intel64"
    LIBS="-framework CoreAudio"
    
    # Add MP3 support if requested
    if [ $USE_MP3 -eq 1 ]; then
        LIB_PATH="libs/macos-$LIB_SUFFIX-libmad.a"
        if [ -f "$LIB_PATH" ]; then
            CFLAGS="$CFLAGS -DMP3_DECODE"
            LIBS="$LIBS $LIB_PATH"
            ranlib "$LIB_PATH"
            echo "Including MP3 support using: $LIB_PATH"
        else
            echo "Warning: MP3 library not found at $LIB_PATH"
        fi
    fi
    
    # Add OGG support if requested
    if [ $USE_OGG -eq 1 ]; then
        LIB_PATH="libs/macos-$LIB_SUFFIX-libvorbisidec.a"
        if [ -f "$LIB_PATH" ]; then
            CFLAGS="$CFLAGS -DOGG_DECODE"
            LIBS="$LIBS $LIB_PATH"
            ranlib "$LIB_PATH"
            echo "Including OGG support using: $LIB_PATH"
        else
            echo "Warning: OGG library not found at $LIB_PATH"
        fi
    fi
    
    # Compile x86_64 version
    echo "Compilation flags (x86_64): $CFLAGS"
    echo "Libraries (x86_64): $LIBS"
    cc $CFLAGS -Wall -O3 sbagen+.c $LIBS -lm -lpthread -o sbagen+.x86_64 || exit 1
    
    # Create universal binary
    echo "Creating universal binary..."
    lipo -create -output sbagen+ sbagen+.arm64 sbagen+.x86_64 || exit 1
    strip sbagen+ || exit 1
    
    # Clean up temporary files
    rm sbagen+.arm64 sbagen+.x86_64
    
    echo "Universal binary created successfully!"
    echo "Supported architectures:"
    lipo -info sbagen+
    
else
    # Set architecture-specific flags for single architecture build
    if [ "$ARCH" = "arm64" ]; then
        CFLAGS="-DT_MACOSX -arch arm64 -mmacosx-version-min=11.0"
        LIB_SUFFIX="arm64"
        echo "Building for Apple Silicon (ARM64)"
    else
        CFLAGS="-DT_MACOSX -arch x86_64 -mmacosx-version-min=10.9"
        LIB_SUFFIX="intel64"
        echo "Building for Intel (x86_64)"
    fi

    # Remove Carbon Framework dependency and ignore deprecated warnings
    CFLAGS="$CFLAGS -DNO_CARBON -Wno-deprecated-declarations"
    LIBS="-framework CoreAudio"

    # Add MP3 support if requested
    if [ $USE_MP3 -eq 1 ]; then
        LIB_PATH="libs/macos-$LIB_SUFFIX-libmad.a"
        if [ -f "$LIB_PATH" ]; then
            CFLAGS="$CFLAGS -DMP3_DECODE"
            LIBS="$LIBS $LIB_PATH"
            ranlib "$LIB_PATH"  # OSX requires running 'ranlib' on .a files
            echo "Including MP3 support using: $LIB_PATH"
        else
            echo "Warning: MP3 library not found at $LIB_PATH"
            echo "MP3 support will not be included"
        fi
    fi

    # Add OGG support if requested
    if [ $USE_OGG -eq 1 ]; then
        LIB_PATH="libs/macos-$LIB_SUFFIX-libvorbisidec.a"
        if [ -f "$LIB_PATH" ]; then
            CFLAGS="$CFLAGS -DOGG_DECODE"
            LIBS="$LIBS $LIB_PATH"
            ranlib "$LIB_PATH"  # OSX requires running 'ranlib' on .a files
            echo "Including OGG support using: $LIB_PATH"
        else
            echo "Warning: OGG library not found at $LIB_PATH"
            echo "OGG support will not be included"
        fi
    fi

    # Compile
    echo "Compilation flags: $CFLAGS"
    echo "Libraries: $LIBS"

    cc $CFLAGS -Wall -O3 sbagen+.c $LIBS -lm -lpthread -o sbagen+ || exit 1
    strip sbagen+ || exit 1

    echo "Compilation successful! Binary created: sbagen+" 
fi 