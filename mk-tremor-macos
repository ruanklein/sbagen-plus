#!/bin/sh

# Script to build Tremor (libvorbisidec) for macOS (both ARM64 and x86_64)
# Usage: ./mk-tremor-macos [-x86]
#   -x86: Build for Intel x86_64 architecture (default is ARM64/Apple Silicon)

# Default settings
ARCH="arm64"

# Parse command line arguments
for arg in "$@"; do
    case "$arg" in
        -x86)
            ARCH="x86_64"
            ;;
        *)
            echo "Unknown option: $arg"
            echo "Usage: ./mk-tremor-macos [-x86]"
            exit 1
            ;;
    esac
done

# Set architecture-specific flags
if [ "$ARCH" = "arm64" ]; then
    CFLAGS="-arch arm64 -mmacosx-version-min=11.0"
    LIB_SUFFIX="arm64"
    echo "Building Tremor for Apple Silicon (ARM64)"
else
    CFLAGS="-arch x86_64 -mmacosx-version-min=10.9"
    LIB_SUFFIX="intel64"
    echo "Building Tremor for Intel (x86_64)"
fi

# Create libs directory if it doesn't exist
mkdir -p libs

# Clone Tremor repository if not already present
if [ ! -d "tremor" ]; then
    echo "Cloning Tremor repository..."
    git clone https://gitlab.xiph.org/xiph/tremor.git
fi

# Configure and build
cd tremor
if [ ! -f "configure" ]; then
    echo "Running autogen.sh..."
    ./autogen.sh
fi

echo "Configuring Tremor..."
CFLAGS="$CFLAGS" ./configure --disable-shared --enable-static --prefix=/tmp/tremor

echo "Building Tremor..."
make clean
make -j4

echo "Installing Tremor to temporary location..."
make install

echo "Copying libvorbisidec.a to libs directory..."
cp /tmp/tremor/lib/libvorbisidec.a ../libs/macos-$LIB_SUFFIX-libvorbisidec.a

echo "Cleaning up..."
cd ..

echo "Build complete! Library created: libs/macos-$LIB_SUFFIX-libvorbisidec.a" 