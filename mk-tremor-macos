#!/bin/sh

# Script to compile the Tremor library (OGG) for macOS
# Usage: ./mk-tremor-macos [-x86]
#   -x86: Build for Intel x86_64 architecture (default is ARM64/Apple Silicon)

# Default settings
ARCH="arm64"

# Parse command line arguments
for arg in "$@"; do
    case "$arg" in
        -x86)
            ARCH="x86_64"
            ;;
        *)
            echo "Unknown option: $arg"
            echo "Usage: ./mk-tremor-macos [-x86]"
            exit 1
            ;;
    esac
done

# Make sure you have the Tremor source code
# You can get it from: https://gitlab.xiph.org/xiph/tremor

# Directory where the Tremor source code is located
TREMOR_SRC="tremor"

# Check if the directory exists
if [ ! -d "$TREMOR_SRC" ]; then
    echo "Directory $TREMOR_SRC not found!"
    echo "Please clone the Tremor repository:"
    echo "git clone https://gitlab.xiph.org/xiph/tremor.git"
    exit 1
fi

# Enter the Tremor directory
cd "$TREMOR_SRC" || exit 1

# Set architecture-specific flags
if [ "$ARCH" = "arm64" ]; then
    export CFLAGS="-O3 -arch arm64 -mmacosx-version-min=11.0"
    export LDFLAGS="-arch arm64 -mmacosx-version-min=11.0"
    LIB_SUFFIX="arm64"
    HOST="arm64-apple-darwin"
    echo "Building for Apple Silicon (ARM64)"
else
    export CFLAGS="-O3 -arch x86_64 -mmacosx-version-min=10.9"
    export LDFLAGS="-arch x86_64 -mmacosx-version-min=10.9"
    LIB_SUFFIX="intel64"
    HOST="x86_64-apple-darwin"
    echo "Building for Intel (x86_64)"
fi

# Run autogen and configure
./autogen.sh || exit 1
./configure --host=$HOST || exit 1

# Compile
make clean
make || exit 1

# Copy the library to the libs directory
cd ..
cp "$TREMOR_SRC/.libs/libvorbisidec.a" libs/macos-$LIB_SUFFIX-libvorbisidec.a || exit 1
ranlib libs/macos-$LIB_SUFFIX-libvorbisidec.a || exit 1

# Copy the necessary headers
cp "$TREMOR_SRC/ivorbiscodec.h" libs/ || exit 1
cp "$TREMOR_SRC/ivorbisfile.h" libs/ || exit 1
cp "$TREMOR_SRC/config_types.h" libs/ || exit 1
cp "$TREMOR_SRC/ogg/ogg.h" libs/ || exit 1
cp "$TREMOR_SRC/ogg/os_types.h" libs/ || exit 1

echo "Tremor library (OGG) successfully compiled for $ARCH!" 