#!/bin/sh

# Script to compile the libmad library for macOS
# Usage: ./mk-libmad-macos [-x86]
#   -x86: Build for Intel x86_64 architecture (default is ARM64/Apple Silicon)

# Default settings
ARCH="arm64"

# Parse command line arguments
for arg in "$@"; do
    case "$arg" in
        -x86)
            ARCH="x86_64"
            ;;
        *)
            echo "Unknown option: $arg"
            echo "Usage: ./mk-libmad-macos [-x86]"
            exit 1
            ;;
    esac
done

# Make sure you have the libmad source code
# You can get it from: http://sourceforge.net/projects/mad/files/libmad/

# Directory where the libmad source code is located
LIBMAD_SRC="libmad-0.15.1b"

# Check if the directory exists
if [ ! -d "$LIBMAD_SRC" ]; then
    echo "Directory $LIBMAD_SRC not found!"
    echo "Please download the libmad source code and extract it here."
    echo "You can get it from: http://sourceforge.net/projects/mad/files/libmad/"
    exit 1
fi

# Enter the libmad directory
cd "$LIBMAD_SRC" || exit 1

# Set architecture-specific flags
if [ "$ARCH" = "arm64" ]; then
    export CFLAGS="-O3 -arch arm64 -mmacosx-version-min=11.0"
    export LDFLAGS="-arch arm64 -mmacosx-version-min=11.0"
    LIB_SUFFIX="arm64"
    HOST="arm64-apple-darwin"
    echo "Building for Apple Silicon (ARM64)"
else
    export CFLAGS="-O3 -arch x86_64 -mmacosx-version-min=10.9"
    export LDFLAGS="-arch x86_64 -mmacosx-version-min=10.9"
    LIB_SUFFIX="intel64"
    HOST="x86_64-apple-darwin"
    echo "Building for Intel (x86_64)"
fi

# Run configure
./configure --host=$HOST || exit 1

# Compile
make clean
make || exit 1

# Copy the library to the libs directory
cd ..
cp "$LIBMAD_SRC/.libs/libmad.a" libs/macos-$LIB_SUFFIX-libmad.a || exit 1
ranlib libs/macos-$LIB_SUFFIX-libmad.a || exit 1

echo "libmad library successfully compiled for $ARCH!" 